const fs = require("fs");

// โหลดข้อมูลเมนู
const rawData = fs.readFileSync("AllMenus.json", "utf-8");
const menus = JSON.parse(rawData);

// ✅ กฎการจัด tag (เวอร์ชันลบนมทั้งหมด)
const tagRules = {
  "โปรตีนสูง": ["อกไก่", "ไข่", "เต้าหู้", "ปลา", "ถั่ว", "โปรตีน", "กุ้ง", "หมู", "เนื้อ"],
  "พลังงานสูง": ["ข้าว", "มัน", "กล้วย", "ธัญพืช", "คาร์โบไฮเดรต", "แคลอรี่สูง", "ไขมันดี"],
  "แคลอรี่ต่ำ": ["ผัก", "ต้ม", "นึ่ง", "น้ำซุป", "แคลอรี่ต่ำ", "เบา", "ย่อยง่าย"],
  "ไขมันต่ำ": ["ไม่ทอด", "นึ่ง", "ต้ม", "ไม่มีน้ำมัน", "ไขมันต่ำ"],
  "ไม่ใส่น้ำตาล": ["ไม่หวาน", "ไม่มีน้ำตาล", "ไม่ใส่น้ำตาล"],
  "โซเดียมต่ำ": ["จืด", "ไม่เค็ม", "โซเดียมต่ำ", "เบาเค็ม"],
  "ข้าวกล้อง": ["ข้าวกล้อง"],
  "มังสวิรัติ": ["เต้าหู้", "เห็ด", "ไม่มีเนื้อสัตว์", "ผักล้วน"],
  "วีแกน": ["ไม่มีเนื้อสัตว์", "ไม่มีไข่", "มังสวิรัติแท้"], // ❌ ลบนมออก
  "ทำง่าย": ["ง่าย", "สะดวก", "วัตถุดิบน้อย"],
  "ต้ม": ["ต้ม"],
  "นึ่ง": ["นึ่ง"],
  "อบ": ["อบ"],
  "ผัด": ["ผัด"],
  "ทอด": ["ทอด"],
  "กล่องเดียวจบ": ["กล่อง", "จานเดียว", "ครบจบ", "พกพาสะดวก"],
  "ทำกินที่บ้าน": ["ทำเอง", "บ้าน", "เตา", "หม้อ"],
  "สุขภาพ": ["สุขภาพ", "clean", "เฮลท์ตี้", "เพื่อสุขภาพ"],

  "หมู": ["หมู", "หมูสับ", "หมูบด", "สันคอหมู", "เนื้อหมู"],
  "ไก่": ["ไก่", "อกไก่", "เนื้อไก่"],
  "เนื้อ": ["เนื้อ", "เนื้อวัว"],
  "ปลา": ["ปลา", "ปลานิล", "ปลาทู", "ปลากะพง", "เนื้อปลา"],
  "กุ้ง": ["กุ้ง", "กุ้งขาว", "กุ้งแช่บ๊วย"],
  "อาหารทะเล": ["ปลาหมึก", "หอย", "ทะเล", "ซีฟู้ด"],
  "ไข่": ["ไข่", "ไข่นึ่ง", "ไข่เจียว", "ไข่ดาว", "ไข่ต้ม"]

  // ❌ ไม่มี "นม", "ชีส", "โยเกิร์ต" ใด ๆ อีก
};

// ✅ ใช้ includes สำหรับภาษาไทย
function extractTags(menu) {
  const content = [...(menu.ingredients || []), menu.description || "", menu.name || ""]
    .join(" ")
    .toLowerCase();

  const tags = new Set();

  for (const [tag, keywords] of Object.entries(tagRules)) {
    for (const keyword of keywords) {
      if (content.includes(keyword.toLowerCase())) {
        tags.add(tag);
        break;
      }
    }
  }

  return Array.from(tags).sort();
}

// ✅ ประมวลผล
menus.forEach(menu => {
  menu.tags = extractTags(menu);
});

// ✅ เขียนไฟล์ใหม่
fs.writeFileSync("AllMenus_tagged_cleaned.json", JSON.stringify(menus, null, 2), "utf-8");

console.log("✅ สร้างไฟล์ AllMenus_tagged_cleaned.json เรียบร้อย");
